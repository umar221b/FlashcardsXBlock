[tasks.clean]
description = "Remove generated byte code, coverage reports, and build artifacts"
run = '''
find . -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -name "*.pyc" -exec rm -f {} + 2>/dev/null || true
find . -name "*.pyo" -exec rm -f {} + 2>/dev/null || true
find . -name "*~" -exec rm -f {} + 2>/dev/null || true
if command -v coverage >/dev/null 2>&1; then
    coverage erase
fi
rm -rf build/ dist/ *.egg-info htmlcov/
'''

[tasks.coverage]
description = "Generate and view HTML coverage report"
depends = ["clean"]
run = '''
pytest --cov-report html
if command -v python >/dev/null 2>&1; then
    python -m webbrowser file://$(pwd)/htmlcov/index.html
fi
'''

[tasks.requirements]
description = "Install development environment requirements"
run = "uv sync"

[tasks.quality]
description = "Check coding style with ruff"
run = "tox -e quality"

[tasks.test]
description = "Run tests in the current virtualenv"
depends = ["clean"]
run = "pytest"

[tasks.test-all]
description = "Run all tests using tox"
run = "tox --parallel"

[tasks.diff-cover]
description = "Find diff lines that need test coverage"
depends = ["test"]
run = "diff-cover coverage.xml"

[tasks.validate]
description = "Run tests and quality checks"
depends = ["quality", "test"]

[tasks.upgrade]
description = "Update the lock file with the latest packages"
depends = ["common-constraints"]
run = '''
uv venv --allow-existing
uv lock --upgrade
'''

[tasks.lint]
description = "Format and lint all files with ruff"
run = "ruff format && ruff check --fix"

[tasks.common-constraints]
description = "Download and process common constraints from edx-lint"
run = '''
CONSTRAINTS_URL="https://raw.githubusercontent.com/edx/edx-lint/master/edx_lint/files/common_constraints.txt"

echo "Downloading and processing constraints from $CONSTRAINTS_URL..."
CONSTRAINTS=$(curl -s "$CONSTRAINTS_URL")

echo "Processing constraints..."

CONSTRAINTS="$CONSTRAINTS" python3 -c "
import os
import re
import tomllib

dev_marker = '# External dev constraints (DO NOT REMOVE THIS LINE)'
main_marker = '# External constraints (DO NOT REMOVE THIS LINE)'

# Read the downloaded constraints from environment variable
constraints_content = os.environ.get('CONSTRAINTS', '')
if not constraints_content:
    print('No constraints data available')
    exit(1)

# Use dev constraints for dependencies that can be modified by tests.
dev_constraints = []
global_constraints = []

# Filter and process constraints.
for line in constraints_content.splitlines():
    line = line.strip()
    if line and not line.startswith('#'):
        if line.startswith('Django'):
            dev_constraints.append(line)
        else:
            global_constraints.append(line)

print('Updating pyproject.toml...')

# Read as text to preserve formatting and comments.
with open('pyproject.toml', 'r') as f:
    content = f.read()

def update_constraints_section(content: str, marker: str, constraints: list[str]) -> str:
    if not constraints:
        return content

    # Find the marker line and replace until the closing bracket.
    result_lines = []
    in_section = False

    for line in content.split('\n'):
        if marker in line:
            result_lines.append(line)
            # Add constraints
            for constraint in constraints:
                result_lines.append(f'    \"{constraint}\",')
            in_section = True
        elif in_section and line.strip() == ']':
            in_section = False
            result_lines.append(line)
        elif not in_section:
            result_lines.append(line)

    return '\n'.join(result_lines)

# Update both sections.
content = update_constraints_section(content, dev_marker, dev_constraints)
content = update_constraints_section(content, main_marker, global_constraints)

# Write the updated file.
with open('pyproject.toml', 'w') as f:
    f.write(content)

# Validate the updated file can still be parsed.
try:
    with open('pyproject.toml', 'rb') as f:
        tomllib.load(f)
    print('Constraints updated successfully and TOML is valid.')
except tomllib.TOMLDecodeError as e:
    print(f'Error: Updated TOML file is invalid: {e}')
    exit(1)
"
'''

[tasks.frontend-install]
description = "Install frontend dependencies"
dir = "frontend"
run = "npm install"

[tasks.frontend-build]
description = "Build frontend assets"
dir = "frontend"
run = '''
SYSTEM="{{ arg(name='system', default='all') }}"
if [ "$SYSTEM" != "all" ]; then
    npm run "build:$SYSTEM"
else
    npm run build
fi
'''

[tasks.frontend-dev]
description = "Start frontend development server"
dir = "frontend"
run = "npm run dev"

[tasks.frontend-test]
description = "Run frontend tests"
dir = "frontend"
run = "npm test"
